<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç»™å°é›¯çš„ä¸€å°ä¿¡ ğŸ’Œ</title>
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        body {
            background-color: #121212; color: #e0e0e0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0; padding: 0;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; overflow-x: hidden; touch-action: manipulation;
        }

        /* --- è°ƒè¯•ä¿¡æ¯ (å³ä¸Šè§’) --- */
        #debug-info {
            position: fixed; top: 10px; right: 10px;
            font-size: 10px; color: rgba(255,255,255,0.3);
            pointer-events: none; z-index: 20000;
        }

        /* --- éŸ³ä¹æŒ‰é’® --- */
        .music-control-btn {
            position: fixed; top: 20px; right: 20px;
            width: 40px; height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%; color: #fff; font-size: 18px;
            z-index: 19999; cursor: pointer; display: none;
            justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        .music-control-btn.playing {
            animation: spin 4s linear infinite;
            background: rgba(255, 154, 158, 0.4); border-color: #ff9a9e;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- å°é¢æ ·å¼ --- */
        #welcome-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.8s ease;
        }
        .open-btn {
            background: linear-gradient(45deg, #ff9a9e 0%, #fecfef 100%);
            border: none; border-radius: 50px; padding: 18px 40px;
            color: #333; font-size: 18px; font-weight: bold;
            box-shadow: 0 0 20px rgba(255, 154, 158, 0.6);
            cursor: pointer; z-index: 10000; animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 20px rgba(255, 154, 158, 0.6); }
            50% { transform: scale(1.05); box-shadow: 0 0 30px rgba(255, 154, 158, 0.9); }
            100% { transform: scale(1); box-shadow: 0 0 20px rgba(255, 154, 158, 0.6); }
        }

        /* --- è›‹ç³•äº’åŠ¨å±å¹• --- */
        #candle-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #2a2a2a 0%, #000 100%);
            z-index: 8888; display: none; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 1s ease;
        }
        .cake-stage { position: relative; width: 200px; height: 200px; margin-bottom: 80px; transform: scale(1.2); }
        .cake-base {
            position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 180px; height: 60px; background: #f8c2c2;
            border-radius: 50% 50% 10px 10px / 30% 30% 10px 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3), inset 0 -10px 20px rgba(0,0,0,0.1);
        }
        .cake-base::before {
            content: ''; position: absolute; top: -20px; left: 0; width: 100%; height: 40px;
            background: #fff5f5; border-radius: 50%; box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        }
        .cake-icing { position: absolute; top: -5px; left: 10px; width: 160px; height: 20px; background: #fff; border-radius: 20px; z-index: 1; }
        .cherry { position: absolute; width: 20px; height: 20px; background: #d32f2f; border-radius: 50%; box-shadow: inset 0 -3px 5px rgba(0,0,0,0.3); z-index: 2; }
        .c1 { top: -25px; left: 30px; } .c2 { top: -25px; right: 30px; } .c3 { top: -15px; left: 80px; }
        .candle {
            position: absolute; bottom: 50px; width: 16px; height: 70px;
            background: repeating-linear-gradient(45deg, #e3f2fd, #e3f2fd 5px, #90caf9 5px, #90caf9 10px);
            border-radius: 4px; z-index: 5; box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        }
        .candle-left { left: 70px; } .candle-right { left: 110px; }
        .candle-num { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #1565c0; font-weight: bold; font-size: 14px; }
        .wick { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 2px; height: 10px; background: #333; }
        .flame {
            position: absolute; top: -30px; left: 50%; transform: translateX(-50%);
            width: 18px; height: 28px;
            background: radial-gradient(ellipse at bottom, #ffff00 0%, #ff6a00 60%, transparent 100%);
            border-radius: 50% 50% 20% 20% / 60% 60% 40% 40%;
            filter: blur(1px); animation: flicker 0.4s infinite alternate;
            transform-origin: center bottom; transition: all 0.5s ease;
        }
        .flame.out { opacity: 0; transform: translateX(-50%) scale(0.1); }
        @keyframes flicker { 0% { transform: translateX(-50%) scale(1); opacity: 0.9; } 100% { transform: translateX(-50%) scale(0.9, 1.1) rotate(3deg); opacity: 1; } }
        .blow-hint { color: #ff9a9e; font-size: 18px; margin-top: 20px; opacity: 0.8; animation: pulseText 2s infinite; text-align: center; }
        @keyframes pulseText { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }

        /* --- æ­£æ–‡æ ·å¼ --- */
        .container {
            width: 100%; max-width: 600px; text-align: left;
            margin-top: 60px; margin-bottom: 50px; padding: 20px;
            box-sizing: border-box; opacity: 0; transition: opacity 1.5s ease; display: none;
        }
        h1 { font-size: 22px; color: #ff9a9e; margin-bottom: 30px; text-align: center; letter-spacing: 1px; font-weight: 300; }
        .story-text {
            font-size: 16px; line-height: 1.7; margin-bottom: 25px; opacity: 0; transform: translateY(20px); transition: all 1s ease;
            background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px; border-left: 3px solid #ff9a9e;
        }
        .visible { opacity: 1; transform: translateY(0); }
        strong { color: #fff; font-weight: 600; }
        .card-box { background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%); border: 1px solid #444; padding: 20px; border-radius: 12px; margin-top: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); text-align: center; }
        .card-title { color: #ffcc00; font-size: 18px; font-weight: bold; margin-bottom: 10px; display: block; }
        .interaction-area { margin-top: 40px; text-align: center; width: 100%; padding-bottom: 60px; }
        .action-btn { background: linear-gradient(45deg, #ff9a9e 0%, #fecfef 100%); border: none; border-radius: 30px; padding: 15px 35px; color: #333; font-size: 16px; font-weight: bold; box-shadow: 0 4px 15px rgba(255, 154, 158, 0.4); cursor: pointer; transition: transform 0.2s; outline: none; -webkit-tap-highlight-color: transparent; }
        .action-btn:active { transform: scale(0.95); }
        #response-text { margin-top: 20px; font-size: 16px; color: #ff9a9e; min-height: 30px; font-weight: 500; }
    </style>
</head>
<body>

    <div id="debug-info">Ready</div>

    <audio id="bgm" loop preload="auto">
        <source src="bgm.mp3" type="audio/mpeg">
    </audio>

    <button id="music-toggle" class="music-control-btn">ğŸµ</button>

    <div id="welcome-screen">
        <div style="font-size: 40px; margin-bottom: 20px;">ğŸ’Œ</div>
        <p style="color: #bbb; margin-bottom: 30px; letter-spacing: 2px;">TO: å°é›¯</p>
        <button class="open-btn" id="start-btn">ç‚¹å‡»æ‹†å¼€</button>
    </div>

    <div id="candle-screen">
        <div class="cake-stage">
            <div class="cake-base">
                <div class="cake-icing"></div>
                <div class="cherry c1"></div>
                <div class="cherry c2"></div>
                <div class="cherry c3"></div>
            </div>
            <div class="candle candle-left">
                <div class="flame" id="flame1"></div>
                <div class="wick"></div>
                <div class="candle-num">2</div>
            </div>
            <div class="candle candle-right">
                <div class="flame" id="flame2"></div>
                <div class="wick"></div>
                <div class="candle-num">1</div>
            </div>
        </div>
        <p class="blow-hint" id="blow-hint-text">ğŸ‚ è®¸ä¸ªæ„¿ï¼Œå¹ç­21å²çš„èœ¡çƒ›~</p>
        <p style="font-size: 12px; color: #888; margin-top: 10px;">(å¯¹ç€æ‰‹æœºéº¦å…‹é£ç”¨åŠ›å¹æ°”)</p>
    </div>

    <div class="container" id="main-content">
        <h1>Happy Birthday ğŸ‚</h1>

        <div class="story-text" id="p1">
            å˜¿ï¼Œç”Ÿæ—¥å¿«ä¹ã€‚<br><br>
            æœ€è¿‘æˆ‘ä»¬æ€»æ˜¯æ‹‰æ‹‰æ‰¯æ‰¯ï¼Œæœ‰äº›è¯åœ¨å¾®ä¿¡é‡Œè¾“äº†åˆåˆ ã€‚ç´¢æ€§è¶ç€ä»Šå¤©ï¼Œæˆ‘æƒ³æŠŠè¿™äº›å¿ƒé‡Œè¯ï¼Œå†™è¿›è¿™ä¸²åªæœ‰ä½ èƒ½çœ‹åˆ°çš„é“¾æ¥é‡Œã€‚<br><br>
            å›æƒ³ä»9æœˆ8å·åˆè¯†åˆ°ç°åœ¨çš„è¿‡å±±è½¦ï¼Œè™½ç„¶11æœˆ17å·ä¹‹åæˆ‘ä»¬è¯•å›¾é€€å›â€œæœ‹å‹â€çš„ä½ç½®ï¼Œä½†ä½ ä¹Ÿå‘ç°äº†å¯¹å§ï¼Ÿæ„Ÿæƒ…è¿™ä¸œè¥¿ï¼Œæ¯”æˆ‘ä»¬æƒ³è±¡çš„æ›´æœ‰æƒ¯æ€§ã€‚
        </div>

        <div class="story-text" id="p2">
            å…¶å®ï¼Œæˆ‘ä¸éœ€è¦ä»»ä½•æ ‡ç­¾æ¥å®šä¹‰ä½ ã€‚<br>
            <strong>è¿™å‡ ä¸ªæœˆçš„ç›¸å¤„ï¼Œè®©æˆ‘çœ‹åˆ°äº†å¾ˆå¤šåˆ«äººä¹Ÿè®¸æ²¡ç•™æ„çš„ç»†èŠ‚ã€‚</strong><br><br>
            æˆ‘ä¹Ÿæ…¢æ…¢ä¹ æƒ¯äº†ä½ çš„é‚£äº›å¯çˆ±çš„å°è„¾æ°”ã€‚<br>
            æˆ‘çœ‹è¿‡ä½ åƒä¸ªå°å­©ä¸€æ ·çªç„¶ç‚¸æ¯›ï¼Œ<br>
            ä¹Ÿè§è¿‡ä½ æ˜æ˜å¿ƒè½¯ï¼Œå˜´ä¸Šå´ä¸é¥¶äººçš„æ ·å­ã€‚<br><br>
            åˆ«äººå¯èƒ½è§‰å¾—éš¾æï¼Œ<strong>ä½†åœ¨æˆ‘çœ¼é‡Œï¼Œè¿™äº›éƒ½æ˜¯ä½ æœ€çœŸå®ã€æœ€ç”ŸåŠ¨çš„éƒ¨åˆ†ã€‚</strong>
        </div>

        <div class="story-text" id="p3">
            æ‰€ä»¥ï¼Œæˆ‘æƒ³ç»™ä½ ä¸€ä»½ç‰¹æ®Šçš„ç”Ÿæ—¥ç¤¼ç‰©ã€‚ä¸æ˜¯æ²‰é‡çš„æ‰¿è¯ºï¼Œè€Œæ˜¯ä¸€å¼ ï¼š
            
            <div class="card-box">
                <span class="card-title">âœ¨ å°é›¯ä¸“å± Â· é•¿æœŸç‰¹æƒå¡ âœ¨</span>
                <div style="font-size: 14px; color: #bbb; line-height: 1.6;">
                    åœ¨æˆ‘ä»¬ç›¸å¤„çš„æ—¥å­é‡Œï¼Œä½ ä¸å¿…åšä¸€ä¸ªå®Œç¾çš„å¤§äººã€‚<br>
                    ä½ æƒ³ç”Ÿæ°”å°±ç”Ÿæ°”ï¼Œæƒ³ä»»æ€§å°±ä»»æ€§ã€‚<br>
                    <strong>ä½ çš„å¼€å¿ƒæˆ‘é™ªç€ï¼Œä½ çš„å°è„¾æ°”æˆ‘ç…§å•å…¨æ”¶ã€‚</strong>
                </div>
            </div>
        </div>

        <div class="story-text" id="p4">
            ç°å®ä¹Ÿè®¸æœ‰å¾ˆå¤šæ— å¥ˆï¼Œæˆ‘ä¹Ÿè®¸ä¸èƒ½æ—¶åˆ»æŒ¡åœ¨ä½ å‰é¢ï¼Œä½†æˆ‘å¸Œæœ›èƒ½æˆä¸ºä½ çš„<strong>â€œåå¤‡éšè—å…³å¡â€</strong>ã€‚<br><br>
            å½“ä½ ç´¯äº†ã€æ°”äº†ã€æˆ–è€…åªæƒ³æ‰¾äººå‘æ³„çš„æ—¶å€™ï¼Œä½ å¯ä»¥éšæ—¶èº²è¿›æˆ‘è¿™é‡Œã€‚<br><br>
            ä¸ç”¨æœ‰å‹åŠ›ï¼Œä¹Ÿä¸ç”¨æƒ³ä»¥åã€‚<br>
            <strong>æ­¤æ—¶æ­¤åˆ»ï¼Œæˆ‘åªæƒ³è®©ä½ å¿«ä¹ã€‚</strong>
        </div>

        <div class="interaction-area">
            <p style="font-size: 13px; color: #666; margin-bottom: 15px;">ğŸ‘‡ å¿ƒæƒ…ä¸å¥½çš„æ—¶å€™ï¼Œç‚¹è¿™é‡Œè¯•ç”¨ä¸€ä¸‹ç‰¹æƒ</p>
            <button class="action-btn" id="anger-btn">ğŸ˜¤ å“¼ï¼Œæˆ‘ç°åœ¨å°±æœ‰å°è„¾æ°”ï¼</button>
            <div id="response-text"></div>
        </div>
    </div>

    <script>
        const startBtn = document.getElementById('start-btn');
        const welcomeScreen = document.getElementById('welcome-screen');
        const candleScreen = document.getElementById('candle-screen');
        const mainContent = document.getElementById('main-content');
        const audio = document.getElementById('bgm');
        const musicBtn = document.getElementById('music-toggle');
        const flame1 = document.getElementById('flame1');
        const flame2 = document.getElementById('flame2');
        const blowHintText = document.getElementById('blow-hint-text');
        const debugInfo = document.getElementById('debug-info');

        let audioContext;
        let microphone;
        let analyser;
        let isBlowing = false;

        // --- å¼ºåˆ¶å”¤é†’éŸ³é¢‘ (å…¼å®¹iOS/å¾®ä¿¡) ---
        function forceAudioUnlock() {
            if(audio.paused) {
                audio.play().then(() => {
                    audio.pause();
                    audio.currentTime = 0;
                }).catch(e=>{});
            }
        }
        document.addEventListener('touchstart', forceAudioUnlock, {once:true});
        document.addEventListener('click', forceAudioUnlock, {once:true});

        // --- éŸ³ä¹æŒ‰é’®æ§åˆ¶ ---
        musicBtn.addEventListener('click', () => {
            if (audio.paused) {
                audio.play();
                musicBtn.classList.add('playing');
                musicBtn.innerText = "ğŸµ";
                debugInfo.innerText = "Music: Playing";
            } else {
                audio.pause();
                musicBtn.classList.remove('playing');
                musicBtn.innerText = "ğŸ”‡";
                debugInfo.innerText = "Music: Paused";
            }
        });

        // --- å¼€å§‹æŒ‰é’® ---
        startBtn.addEventListener('click', () => {
            // 1. å°è¯•æ’­æ”¾éŸ³ä¹
            audio.play().then(() => {
                musicBtn.classList.add('playing');
                debugInfo.innerText = "Music: Started";
            }).catch(e => {
                console.log(e);
                debugInfo.innerText = "Music: Autoplay Blocked (Tap btn)";
            });

            // 2. æ˜¾ç¤ºUI
            musicBtn.style.display = 'flex';
            welcomeScreen.style.opacity = 0;
            
            setTimeout(() => {
                welcomeScreen.style.display = 'none';
                candleScreen.style.display = 'flex';
                startMicrophone();
            }, 800);
        });

        // --- éº¦å…‹é£ ---
        function startMicrophone() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                 blowHintText.innerText = "âš ï¸ æµè§ˆå™¨ä¸æ”¯æŒéº¦å…‹é£ï¼Œç‚¹å‡»å±å¹•ç»§ç»­";
                 document.addEventListener('click', blowOutCandle, {once:true});
                 return;
            }

            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 512;

            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    blowHintText.innerText = "ğŸ¤ å·²è¿æ¥ï¼Œç”¨åŠ›å¹æ°”è®¸æ„¿å§~";
                    microphone = audioContext.createMediaStreamSource(stream);
                    microphone.connect(analyser);
                    detectBlow();
                })
                .catch(err => {
                    blowHintText.innerText = "âš ï¸ éº¦å…‹é£æƒé™è¢«æ‹’ï¼Œç‚¹å‡»å±å¹•ç»§ç»­";
                    document.addEventListener('click', blowOutCandle, {once:true});
                });
        }

        function detectBlow() {
            if (isBlowing) return;
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);

            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) { sum += dataArray[i]; }
            let average = sum / dataArray.length;

            // å¹æ°”çµæ•åº¦é˜ˆå€¼ï¼š45 (æ•°å€¼è¶Šå¤§è¶Šéš¾å¹ç­)
            if (average > 45) { 
                blowOutCandle();
            } else {
                requestAnimationFrame(detectBlow);
            }
        }

        function blowOutCandle() {
            if(isBlowing) return;
            isBlowing = true;
            flame1.classList.add('out');
            flame2.classList.add('out');
            blowHintText.innerText = "âœ¨ æ„¿æœ›å®ç° âœ¨";
            
            if(microphone) microphone.disconnect();
            if(audioContext) audioContext.close();

            setTimeout(() => {
                candleScreen.style.opacity = 0;
                setTimeout(() => {
                    candleScreen.style.display = 'none';
                    mainContent.style.display = 'block';
                    setTimeout(() => {
                        mainContent.style.opacity = 1;
                        startTextAnimation();
                    }, 100);
                }, 1000);
            }, 1500);
        }

        function startTextAnimation() {
            const paragraphs = ['p1', 'p2', 'p3', 'p4'];
            let delay = 500;
            paragraphs.forEach((id) => {
                setTimeout(() => {
                    document.getElementById(id).classList.add('visible');
                }, delay);
                delay += 2200;
            });
        }

        const btn = document.getElementById('anger-btn');
        const response = document.getElementById('response-text');
        let clickCount = 0;
        const messages = [
            "æ”¶åˆ°ï¼æ­£åœ¨å¯åŠ¨æ— æ¡ä»¶åŒ…å®¹æ¨¡å¼... ğŸ›¡ï¸",
            "è°æƒ¹å°é›¯äº†ï¼Ÿå‘Šè¯‰æˆ‘ï¼Œæˆ‘å»å¸®ä½ å‡ºæ°”ï¼ğŸ‘Š",
            "å¥½å•¦å¥½å•¦ï¼Œä¸æ°”ä¸æ°”ï¼ŒæŠ±æŠ±~ ğŸ«‚",
            "ä¸ç®¡ä½ æ€ä¹ˆé—¹ï¼Œæˆ‘éƒ½æœ€å–œæ¬¢ä½ ã€‚â¤ï¸ ç”Ÿæ—¥å¿«ä¹ï¼"
        ];
        btn.addEventListener('click', () => {
            if (clickCount < messages.length) {
                response.innerHTML = messages[clickCount];
                if(navigator.vibrate) navigator.vibrate(50); 
                clickCount++;
            }
            if (clickCount === messages.length) {
                btn.style.background = "#ddd";
                btn.innerText = "â¤ï¸ æ°¸è¿œæœ‰æ•ˆ";
                btn.disabled = true;
            }
        });
    </script>

    <script>
    (function(window, document, undefined) {
        var hearts = [];
        window.requestAnimationFrame = (function() {
            return window.requestAnimationFrame ||
                window.webkitRequestAnimationFrame ||
                window.mozRequestAnimationFrame ||
                window.oRequestAnimationFrame ||
                window.msRequestAnimationFrame ||
                function(callback) { setTimeout(callback, 1000 / 60); }
        })();
        init();
        function init() {
            css(".heart{width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: fixed;}.heart:after{top: -5px;}.heart:before{left: -5px;}");
            attachEvent();
            gameloop();
        }
        function gameloop() {
            for (var i = 0; i < hearts.length; i++) {
                if (hearts[i].alpha <= 0) {
                    document.body.removeChild(hearts[i].el);
                    hearts.splice(i, 1);
                    continue;
                }
                hearts[i].y--;
                hearts[i].scale += 0.004;
                hearts[i].alpha -= 0.013;
                hearts[i].el.style.cssText = "left:" + hearts[i].x + "px;top:" + hearts[i].y + "px;opacity:" + hearts[i].alpha + ";transform:scale(" + hearts[i].scale + ") rotate(45deg);background:" + hearts[i].color + ";z-index:99999";
            }
            requestAnimationFrame(gameloop);
        }
        function attachEvent() {
            var old = typeof window.onclick === "function" && window.onclick;
            window.onclick = function(event) {
                old && old();
                createHeart(event);
            }
        }
        function createHeart(event) {
            var d = document.createElement("div");
            d.className = "heart";
            hearts.push({
                el: d,
                x: event.clientX - 5,
                y: event.clientY - 5,
                scale: 1,
                alpha: 1,
                color: randomColor()
            });
            document.body.appendChild(d);
        }
        function css(css) {
            var style = document.createElement("style");
            style.type = "text/css";
            try { style.appendChild(document.createTextNode(css)); } catch (ex) { style.styleSheet.cssText = css; }
            document.getElementsByTagName('head')[0].appendChild(style);
        }
        function randomColor() {
            return "rgb(" + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + ")";
        }
    })(window, document);
    </script>
</body>
</html>
